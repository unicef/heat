<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />

    <!-- Styles for the map and UI elements -->
    <style>
        #map {
            position: relative;
            /* Add this to enable absolute positioning inside */
            height: 600px;
            width: 100%;
        }
    </style>
</head>

<body>
    <!-- Website title -->
    <h1>Children Exposure to Heatwaves</h1>

    <!-- Control panel for selecting sub-indicator and threshold and download button-->
    <div id="controls">
        <label for="country">Country:</label>
        <select id="country">
            <!-- Options will be populated dynamically -->
        </select>
        <label for="sub-indicator">Select sub-indicator:</label>
        <select id="sub-indicator">
            <option value="Heatwave Frequency">Frequency</option>
            <option value="Heatwave Duration">Duration</option>
            <option value="Heatwave Severity">Severity</option>
            <option value="Extreme Heat Days">Extreme High Temp.</option>
        </select>

        <label for="percentage">Select percentage increase:</label>
        <select id="percentage">
            <option value="50%">50%</option>
            <option value="100%">100%</option>
            <option value="200%">200%</option>
        </select>

        <!-- Button to download CSV -->
        <button id="downloadBtn" style="margin-left: 10px;">Download CSV</button>
    </div>

    <!-- define map container -->
    <div id="map"></div>

    <!-- Sum display -->
    <div id="sum-display"></div>

    <!-- import necessary libraries -->
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

    <script>
        (function () {
            // initalize leaflet map
            var map = L.map('map').setView([40, 0], 2);

            // add OpenStreetMap basemap
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                noWrap: true,
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var geojsonLayer;
            var geojsonData;
            const geojson_Url = "https://unicefdownloadfiletest.blob.core.windows.net/prueba/child_population_geojson.geojson"

            function updateMap(selectedCountry, subIndicator, percentage) {
                if (geojsonLayer) {
                    map.removeLayer(geojsonLayer);
                    map.closePopup();
                }

                var sum = 0;

                geojsonLayer = L.geoJson(geojsonData, {
                    onEachFeature: function (feature, layer) {
                        var countryName = feature.properties['Country Name'];
                        var value = feature.properties[subIndicator + " Increased by " + percentage];

                        // Add to the sum if the value is defined and is a number
                        if (value !== undefined && !isNaN(value)) {
                            sum += value;
                        }

                        // Create popup content
                        var popupContent = `
                        <div class="popup-header">In <strong>${countryName}</strong></div>
                        <div class="popup-content">
                        <strong>${value.toLocaleString()}</strong> children live in areas where the <span>${subIndicator}</span> has increased by <span>${percentage}</span> since the 1970s<br>
                        </div>
                    `;

                        layer.bindPopup(popupContent);

                        if (countryName === selectedCountry) {
                            setTimeout(() => {
                                layer.openPopup();
                            }, 0);
                        }
                    }
                }).addTo(map);

                // Display the sum below the map
                var sumDisplay = document.getElementById('sum-display');
                sumDisplay.innerHTML = `
                Globally, <strong>${sum.toLocaleString()}</strong> children live in areas where the <span>${subIndicator}</span> has increased by <span>${percentage}</span> since the 1970s.
            `;
            }

            function populateCountryOptions() {
                var countrySelect = document.getElementById('country');
                countrySelect.innerHTML = '<option value="">Select a country</option>';
                var countries = [];

                geojsonData.features.forEach(function (feature) {
                    countries.push(feature.properties['Country Name']);
                });

                countries.sort().forEach(function (country) {
                    var option = document.createElement('option');
                    option.value = country;
                    option.text = country;
                    countrySelect.appendChild(option);
                });
            }

            // Load the GeoJSON file
            fetch(geojson_Url)
                .then(response => response.json())
                .then(data => {
                    geojsonData = data;
                    populateCountryOptions();
                    updateMap('', 'Heatwave Frequency', '50%');
                })
                .catch(error => {
                    console.error('Error loading the GeoJSON file:', error);
                });

            document.getElementById('country').addEventListener('change', function () {
                var country = document.getElementById('country').value;
                var subIndicator = document.getElementById('sub-indicator').value;
                var percentage = document.getElementById('percentage').value;
                updateMap(country, subIndicator, percentage);
            });

            // Event listeners for the filters
            document.getElementById('sub-indicator').addEventListener('change', function () {
                var country = document.getElementById('country').value;
                var subIndicator = document.getElementById('sub-indicator').value;
                var percentage = document.getElementById('percentage').value;
                updateMap(country, subIndicator, percentage);
            });

            document.getElementById('percentage').addEventListener('change', function () {
                var country = document.getElementById('country').value;
                var subIndicator = document.getElementById('sub-indicator').value;
                var percentage = document.getElementById('percentage').value;
                updateMap(country, subIndicator, percentage);
            });

            // Listen for a click event on the 'downloadBtn' element and open a new tab with the URL to a TIFF file
            document.getElementById('downloadBtn').addEventListener('click', function () {
                var csvUrl = 'https://unicefdownloadfiletest.blob.core.windows.net/prueba/Exposure_change_for_Countries.csv'
                window.open(csvUrl, '_blank');
            });

        })();
    </script>
</body>

</html>