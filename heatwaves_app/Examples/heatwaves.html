<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
        }

        #controls {
            margin: 10px;
        }

        #legend {
            background: white;
            padding: 10px;
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- define header -->
    <h1>Heatwave Indicators</h1>
    <!-- define controls containers -->
    <div id="controls">
        <label for="bandSelector">Select sub-indicator:</label>
        <select id="bandSelector">
            <option value="0">Frequency</option>
            <option value="1">Duration</option>
            <option value="2">Severity</option>
            <option value="3">Extreme High Temp.</option>
        </select>
        <button id="downloadBtn" style="margin-left: 10px;">Download TIF</button>
    </div>
    <!-- define map container -->
    <div id="map"></div>
    <!-- define colourmap scale container -->
    <div id="legend"></div>
    <!-- define loading message container -->
    <div id="loading"
        style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div class="spinner"
                style="margin: 0 auto; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 2s linear infinite;">
            </div>
            <p style="text-align: center; margin-top: 10px;">Loading...</p>
        </div>
    </div>



    <!-- import necessary libraries -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

    <!-- define map -->
    <script>
        var map = L.map('map', {
            minZoom: 2, // Sets minimum zoom level to prevent zooming out too much
            maxZoom: 18, // Sets maximum zoom level if needed
            maxBounds: [[-90, -180], [90, 180]], // Restricts panning to the extent of the world
            worldCopyJump: false // Prevents the map from wrapping around
        }).setView([40, 0], 2);

        // add open street map layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            noWrap: true,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // define download url for tif file
        var url_to_geotiff_file = "https://unicefdownloadfiletest.blob.core.windows.net/prueba/average_hwi_2020s_proj.tif";
        var currentLayer;

        // Show loading message
        document.getElementById('loading').style.display = 'block';

        fetch(url_to_geotiff_file)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => {
                parseGeoraster(arrayBuffer).then(georaster => {
                    // The next function updates the 'legend' element with a color scale from min to max values of the band.
                    function updateLegend(min, max, scale) {
                        var legend = document.getElementById('legend');
                        legend.innerHTML = '<strong>Color Scale</strong><br>';

                        // Create gradient bar or discrete color steps
                        const steps = 10; // Number of steps in the gradient
                        const range = max - min;
                        for (let i = 0; i <= steps; i++) {
                            const value = min + i * (range / steps);
                            const color = scale(value).hex();
                            legend.innerHTML += `<div style="background-color: ${color}; width: 20px; height: 20px; display: inline-block;"></div>`;
                        }

                        // Append min and max labels below the color bar
                        legend.innerHTML += `<br><label>${min.toFixed(2)}</label><span style="float: right;">${max.toFixed(2)}</span>`;
                    }
                    // The next function adds a color-mapped layer to the map for a specific band and updates the UI.
                    function addLayer(band) {
                        // Recalculate min and max for the selected band
                        const min = georaster.mins[band];
                        const max = georaster.maxs[band];
                        const scale = chroma.scale('OrRd').domain([min, max]); // Recreate the scale

                        updateLegend(min, max, scale);

                        // Remove current layer and add new one corresponding to the selected band:
                        if (currentLayer) {
                            map.removeLayer(currentLayer);
                        }
                        currentLayer = new GeoRasterLayer({
                            attribution: "Unicef",
                            noWrap: true, // to prevent map repeated horizontally
                            georaster: georaster,
                            opacity: 0.7,
                            // Callback for when tiles start loading
                            onTileLoadStart: function () {
                                document.getElementById('loading').style.display = 'block';
                            },
                            // Callback for when all tiles are loaded
                            onTileLoadEnd: function () {
                                document.getElementById('loading').style.display = 'none';
                            },
                            // Callback for when there is an error loading tiles
                            onTileLoadError: function () {
                                document.getElementById('loading').style.display = 'none';
                                alert('Failed to load data. Please try again.');
                            },
                            // The next function maps the pixel values to a color:
                            pixelValuesToColorFn: function (pixelValues) {
                                var pixelValue = pixelValues[band];

                                if (pixelValue === 0 || pixelValue === null || pixelValue === undefined || isNaN(pixelValue)) {
                                    return null; // Returning null will make the pixel transparent
                                }
                                var color = scale(pixelValue).hex();

                                return color;
                            },
                            resolution: 256 // the higher this value, the more detail you get, but also more data to load and process
                        });
                        currentLayer.addTo(map);
                        map.fitBounds(currentLayer.getBounds());
                    }

                    // Hide loading message
                    document.getElementById('loading').style.display = 'none';

                    // Listen for a change event on the 'bandSelector' element and call the addLayer function with the newly selected band index.
                    document.getElementById('bandSelector').addEventListener('change', function (event) {
                        addLayer(parseInt(event.target.value));
                    });
                    // Listen for a click event on the 'downloadBtn' element and open a new window (or tab) with the URL to a GeoTIFF file
                    document.getElementById('downloadBtn').addEventListener('click', function () {
                        window.open(url_to_geotiff_file);
                    });


                    // Initialize with the first band
                    addLayer(0);
                });
            });
    </script>
</body>

</html>