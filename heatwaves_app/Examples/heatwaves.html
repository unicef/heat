<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
        }

        #controls {
            margin: 10px;
        }

        #minMaxDisplay {
            margin: 10px;
        }

        #legend {
            background: white;
            padding: 10px;
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <h1>Heatwave Indicators</h1>
    <div id="controls">
        <label for="bandSelector">Select sub-indicator:</label>
        <select id="bandSelector">
            <option value="0">Frequency</option>
            <option value="1">Duration</option>
            <option value="2">Severity</option>
            <option value="3">Extreme High Temp.</option>
        </select>
    </div>
    <div id="map"></div>
    <div id="minMaxDisplay">
        <strong>Min Value:</strong> <span id="minValue"></span>
        <strong>Max Value:</strong> <span id="maxValue"></span>
    </div>
    <div id="legend"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
    <script>
        var map = L.map('map', {
            minZoom: 2, // Sets minimum zoom level to prevent zooming out too much
            maxZoom: 18, // Sets maximum zoom level if needed
            maxBounds: [[-90, -180], [90, 180]], // Restricts panning to the extent of the world
            worldCopyJump: false // Prevents the map from wrapping around
        }).setView([40, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var url_to_geotiff_file = "https://unicefdownloadfiletest.blob.core.windows.net/prueba/average_hwi_2020s_proj.tif";
        var currentLayer;

        fetch(url_to_geotiff_file)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => {
                parseGeoraster(arrayBuffer).then(georaster => {
                    function updateLegend(min, max, scale) {
                        var legend = document.getElementById('legend');
                        legend.innerHTML = '<strong>Color Scale</strong><br>';

                        // Create gradient bar or discrete color steps
                        const steps = 10; // Number of steps in the gradient
                        const range = max - min;
                        for (let i = 0; i <= steps; i++) {
                            const value = min + i * (range / steps);
                            const color = scale(value).hex();
                            legend.innerHTML += `<div style="background-color: ${color}; width: 20px; height: 20px; display: inline-block;"></div>`;
                        }

                        // Append min and max labels below the color bar
                        legend.innerHTML += `<br><label>${min.toFixed(2)}</label><span style="float: right;">${max.toFixed(2)}</span>`;
                    }

                    function addLayer(band) {
                        // Recalculate min and max for the selected band
                        const min = georaster.mins[band];
                        const max = georaster.maxs[band];
                        const scale = chroma.scale('OrRd').domain([min, max]); // Recreate the scale

                        updateLegend(min, max, scale);

                        document.getElementById('minValue').textContent = min.toFixed(0); // Formatting to 2 decimal places
                        document.getElementById('maxValue').textContent = max.toFixed(0);

                        if (currentLayer) {
                            map.removeLayer(currentLayer);
                        }
                        currentLayer = new GeoRasterLayer({
                            attribution: "x",
                            georaster: georaster,
                            opacity: 0.7,
                            pixelValuesToColorFn: function (pixelValues) {
                                var pixelValue = pixelValues[band];

                                if (pixelValue === 0 || pixelValue === null || pixelValue === undefined) return null;

                                var color = scale(pixelValue).hex();

                                return color;
                            },
                            resolution: 256
                        });
                        currentLayer.addTo(map);
                        map.fitBounds(currentLayer.getBounds());
                    }

                    document.getElementById('bandSelector').addEventListener('change', function (event) {
                        addLayer(parseInt(event.target.value));
                    });

                    // Initialize with the first band
                    addLayer(0);
                });
            });
    </script>
</body>

</html>