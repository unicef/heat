<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!-- Styles for the map and UI elements -->
    <style>
        #controls {
            margin: 10px;
        }

        #map {
            position: relative;
            /* Add this to enable absolute positioning inside */
            height: 600px;
            width: 100%;
        }

        #legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            padding: 10px;
            background: white;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        .color-box {
            width: 20px;
            height: 20px;
            display: inline-block;
            border: 1px solid #ccc;
            margin-right: 5px;
        }

        .color-label {
            display: inline-block;
            font-size: 12px;
        }


        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
        }

        .spinner {
            margin: 0 auto;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
    </style>
</head>

<body>
    <!-- Website title -->
    <h1>Heatwave Indicators</h1>

    <!-- Control panel for selecting year and sub-indicators, and download button -->
    <div id="controls">
        <label for="yearDropdown">Select Year:</label>
        <select id="yearDropdown">
            <option value="1960">1960</option>
            <option value="1970">1970</option>
            <option value="1980">1980</option>
            <option value="1990">1990</option>
            <option value="2000">2000</option>
            <option value="2010">2010</option>
            <option value="2020">2020</option>
        </select>
        <label for="bandSelector">Select sub-indicator:</label>
        <select id="bandSelector">
            <option value="0">Frequency</option>
            <option value="1">Duration</option>
            <option value="2">Severity</option>
            <option value="3">Extreme High Temp.</option>
        </select>
        <button id="downloadBtn" style="margin-left: 10px;">Download TIF</button>
    </div>

    <!-- define map container -->
    <div id="map">
        <!-- define loading message container -->
        <div id="loading">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                <div class="spinner"></div>
                <p style="text-align: center; margin-top: 10px;">Loading...</p>
            </div>
        </div>

        <!-- define colourmap scale container -->
        <div id="legend"></div>
    </div>

    <!-- import necessary libraries -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
    <!-- plugin to search by location -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <!-- Map initialization and control script -->
    <script>
        var map = L.map('map', {
            minZoom: 2,
            maxZoom: 18,
            maxBounds: [[-90, -180], [90, 180]], // Restricts panning to the extent of the world
            worldCopyJump: false // Prevents the map from wrapping around
        }).setView([40, 0], 2);

        // Add Open Street Map layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            noWrap: true,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Searchbox to search by location
        var geocoder = L.Control.geocoder({
            defaultMarkGeocode: false
        }).addTo(map);

        geocoder.on('markgeocode', function (e) {
            var center = e.geocode.center;
            map.setView(center, 4);
        });

        // URL storage for TIFF files, mapped by year
        const tiffUrls = {
            "1960": "https://unicefdownloadfiletest.blob.core.windows.net/prueba/average_hwi_1960s_proj_COG2.tif",
            "1970": "https://unicefdownloadfiletest.blob.core.windows.net/prueba/average_hwi_1970s_proj_COG2.tif",
            "1980": "https://unicefdownloadfiletest.blob.core.windows.net/prueba/average_hwi_1980s_proj_COG2.tif",
            "1990": "https://unicefdownloadfiletest.blob.core.windows.net/prueba/average_hwi_1990s_proj_COG2.tif",
            "2000": "https://unicefdownloadfiletest.blob.core.windows.net/prueba/average_hwi_2000s_proj_COG2.tif",
            "2010": "https://unicefdownloadfiletest.blob.core.windows.net/prueba/average_hwi_2010s_proj_COG2.tif",
            "2020": "https://unicefdownloadfiletest.blob.core.windows.net/prueba/average_hwi_2020s_proj_COG2.tif"
        };

        // Maximum and minimum values per band are determined by calculating the mean and standard deviation for 2020.
        // The maximum value is defined as Max = Mean + 2 Ã— Standard Deviation.
        // Values exceeding this maximum will be saturated to minimize the skewing effect of very high values on the color scaling of the imagery.
        const bandRanges = {
            0: { min: 0, max: 15 },   // Frequency
            1: { min: 0, max: 79 },    // Duration
            2: { min: 0, max: 4 },   // Severity
            3: { min: 0, max: 112 }   // Extreme High Temp.
        };

        var currentLayer, currentGeoRaster, currentBand = 0;
        const loadingDiv = document.getElementById('loading');

        // Show or hide loading spinner accordingly
        function toggleSpinner(show) {
            loadingDiv.style.display = show ? 'block' : 'none';
        }

        // Load TIFF file for the selected year and handle it with GeoRaster
        function loadTiffForYear(year) {
            toggleSpinner(true);

            fetch(tiffUrls[year])
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    parseGeoraster(arrayBuffer).then(georaster => {
                        currentGeoRaster = georaster;
                        addLayer(currentBand);
                        toggleSpinner(false);
                    });
                })
        }

        // Add raster layer to the map and update the legend with color scale
        function addLayer(band) {
            const steps = 5;
            const { min, max } = bandRanges[band];
            const scale = chroma.scale('OrRd').domain([min, max]).classes(steps);
            const colorLookup = scale.colors(steps); // Create a lookup table for colors
            const overflowColor = '#500000';

            if (!currentGeoRaster) return; // Abort if there is no data available.

            // Get color based on the value, clamping it to the min and max of the selected band (to prevent outliers from skewing the perceptual scaling of data).
            function getColor(value, min, max, steps, colorLookup, overflowColor) {
                if (value > max) {
                    // Return a specific color for values greater than max
                    return overflowColor;
                }

                // Calculate the index for the color lookup
                const index = Math.floor(((value - min) / (max - min)) * (steps - 1));

                // Return the color from the lookup
                return colorLookup[index];
            }

            // Update the 'legend' element to visually represent the color scale.
            function updateLegend(min, max, steps) {
                const scale = chroma.scale('OrRd').domain([min, max]).classes(steps);
                var legend = document.getElementById('legend');
                legend.innerHTML = '<strong>Color Scale</strong><br>';

                // Calculate the range step size
                const stepSize = (max - min) / steps;

                // Create the color blocks and labels
                for (let i = 0; i < steps; i++) {
                    const rangeMin = min + i * stepSize;
                    const rangeMax = min + (i + 1) * stepSize;

                    legend.innerHTML += `
                        <div style="background-color: ${scale(rangeMin)}; width: 20px; height: 20px; display: inline-block;"></div>
                        <label>${rangeMin.toFixed(0)} - ${rangeMax.toFixed(0)}</label><br>`;
                }

                // Add a new color box for values higher than the max
                legend.innerHTML += `
                    <div style="background-color: ${overflowColor}; width: 20px; height: 20px; display: inline-block;"></div>
                    <label>${max}+</label><br>`;
            }

            updateLegend(min, max, steps);

            // Remove previous layer (if any)
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // Add new GeoRaster layer
            currentLayer = new GeoRasterLayer({
                attribution: "Unicef",
                noWrap: true, // Prevents from repeating the map at the edges.
                georaster: currentGeoRaster,
                opacity: 0.7,
                // Handle the loading spinner.
                onTileLoadStart: function () {
                    toggleSpinner(true);
                },
                onTileLoadEnd: function () {
                    toggleSpinner(false);
                },
                onTileLoadError: function () {
                    toggleSpinner(false);
                    alert('Failed to load data. Please try again.');
                },
                // Assign colors to individual pixels based on their value
                pixelValuesToColorFn: function (pixelValues) {
                    var pixelValue = pixelValues[band];
                    if (pixelValue === 0 || pixelValue === null || pixelValue === undefined || isNaN(pixelValue)) {
                        return null;
                    }
                    return getColor(pixelValue, min, max, steps, colorLookup, overflowColor);
                },
                resolution: 256
            });
            // Display the layer on the map
            currentLayer.addTo(map);
            // Adjust the map's view to fit the bounds of the newly added raster layer.
            map.fitBounds(currentLayer.getBounds());
        }

        // Initial load
        loadTiffForYear(document.getElementById('yearDropdown').value);

        // Event listeners for dropdown changes and button clicks

        // Listen for a change event on the 'yearDropdown' element and call the loadTiffForYear with the newly selected year.
        document.getElementById('yearDropdown').addEventListener('change', function () {
            var selectedYear = this.value;
            loadTiffForYear(selectedYear);
        });

        // Listen for a change event on the 'bandSelector' element and call the addLayer function with the newly selected band.
        document.getElementById('bandSelector').addEventListener('change', function (event) {
            currentBand = parseInt(event.target.value);
            addLayer(currentBand);
        });

        // Listen for a click event on the 'downloadBtn' element and open a new tab with the URL to a TIFF file
        document.getElementById('downloadBtn').addEventListener('click', function () {
            var year = document.getElementById('yearDropdown').value;
            window.open(tiffUrls[year], '_blank');
        });

    </script>
</body>

</html>