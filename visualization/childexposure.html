<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UNICEF Children's Exposure</title>

    <!-- Leaflet CSS for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <!-- Styles for the map and UI elements -->
    <style>
        #controls {
            margin: 10px;
        }

        #map {
            height: 600px;
            width: 100%;
        }

        .leaflet-container {
            background-color: rgba(255, 0, 0, 0.0);
        }
    </style>
</head>

<body>
    <!-- Website title -->
    <h1>Children's Exposure to Heatwaves</h1>

    <!-- Control panel for selecting country, sub-indicator, percentage increase, and download button-->
    <div id="controls">
        <label for="country">Country:</label>
        <select id="country">
            <!-- Options will be populated dynamically -->
        </select>

        <label for="sub-indicator">Select sub-indicator:</label>
        <select id="sub-indicator">
            <option value="Heatwave Frequency">Frequency</option>
            <option value="Heatwave Duration">Duration</option>
            <option value="Heatwave Severity">Severity</option>
            <option value="Extreme Heat Days">Extreme High Temp.</option>
        </select>

        <label for="percentage">Select percentage increase:</label>
        <select id="percentage">
            <option value="50%">50%</option>
            <option value="100%">100%</option>
            <option value="200%">200%</option>
        </select>

        <!-- Button to download CSV and reset map view -->
        <button id="downloadBtn" style="margin-left: 10px;">Download CSV</button>
        <button id="reset-view">Reset View</button>
    </div>

    <!-- Map container -->
    <div id="map"></div>

    <!-- Sum display -->
    <div id="sum-display"></div>

    <!-- import necessary scripts -->
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        (function () { // This is to be able to embed the script into the index.html
            // initalize leaflet map
            var defaultView = [40, 0];
            var defaultZoom = 2;
            var map = L.map('map', {
                minZoom: 2,
                maxZoom: 18,
                worldCopyJump: false // Prevents the map from wrapping around
            }).setView(defaultView, defaultZoom);

            // add OpenStreetMap basemap
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                noWrap: true,
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Searchbox to search by location
            var geocoder = L.Control.geocoder({
                defaultMarkGeocode: false
            }).addTo(map);

            geocoder.on('markgeocode', function (e) {
                var center = e.geocode.center;
                map.setView(center, 4);
            });

            var geojsonLayer;
            var geojsonData;
            const geojson_Url = "https://unicefdownloadfiletest.blob.core.windows.net/prueba/child_exposure_2023.geojson"

            // Function to update the map based on selected filters
            function updateMap(selectedCountry, subIndicator, percentage) {
                if (geojsonLayer) {
                    map.removeLayer(geojsonLayer);
                    map.closePopup();
                }

                var sum = 0; // For global statistics

                geojsonLayer = L.geoJson(geojsonData, {
                    onEachFeature: function (feature, layer) {
                        var countryName = feature.properties['Country Name'];
                        var value = feature.properties[subIndicator + " Increased by " + percentage];

                        // Add to the global sum if the value is defined and is a number
                        if (value !== undefined && !isNaN(value)) {
                            sum += value;
                        }

                        // Create popup content
                        var popupContent = `
                        <div class="popup-header">In <strong>${countryName}</strong></div>
                        <div class="popup-content">
                            <strong>${value.toLocaleString()}</strong> children live in areas where the <span>${subIndicator}</span> has increased by <span>${percentage}</span> since the 1970s<br>
                        </div>
                    `;

                        layer.bindPopup(popupContent);

                        if (countryName === selectedCountry) {
                            // Use setTimeout to ensure the popup opens after the layer has been added to the map
                            setTimeout(() => {
                                layer.openPopup();
                            }, 0);
                        }
                    }
                }).addTo(map);

                // Display the sum below the map
                var sumDisplay = document.getElementById('sum-display');
                sumDisplay.innerHTML = `
                    Globally, <strong>${sum.toLocaleString()}</strong> children live in areas where the <span>${subIndicator}</span> has increased by <span>${percentage}</span> since the 1970s.
                `;
            }

            // Populate country options dynamically
            function populateCountryOptions() {
                // Get the select element for countries
                var countrySelect = document.getElementById('country');

                // Set the initial option to prompt the user to select a country
                countrySelect.innerHTML = '<option value="">Select a country</option>';

                // Create an empty array to store country names
                var countries = [];

                // Iterate over each feature in the GeoJSON data
                geojsonData.features.forEach(function (feature) {
                    // Extract the country name from the feature properties and add it to the countries array
                    countries.push(feature.properties['Country Name']);
                });

                // Sort the country names alphabetically
                countries.sort().forEach(function (country) {
                    var option = document.createElement('option'); // Create a new option element for each country
                    option.value = country; // Set the value attribute to the country name
                    option.text = country; // Set the displayed text to the country name
                    countrySelect.appendChild(option); // Append the option element to the country select element
                });
            }

            // Load the GeoJSON file
            fetch(geojson_Url)
                .then(response => response.json())
                .then(data => {
                    geojsonData = data;
                    populateCountryOptions();
                    updateMap('', 'Heatwave Frequency', '50%');
                })
                .catch(error => {
                    console.error('Error loading the GeoJSON file:', error);
                });

            // Event listeners for the filters
            document.getElementById('country').addEventListener('change', function () {
                var country = document.getElementById('country').value;
                var subIndicator = document.getElementById('sub-indicator').value;
                var percentage = document.getElementById('percentage').value;
                updateMap(country, subIndicator, percentage);
            });

            document.getElementById('sub-indicator').addEventListener('change', function () {
                var country = document.getElementById('country').value;
                var subIndicator = document.getElementById('sub-indicator').value;
                var percentage = document.getElementById('percentage').value;
                updateMap(country, subIndicator, percentage);
            });

            document.getElementById('percentage').addEventListener('change', function () {
                var country = document.getElementById('country').value;
                var subIndicator = document.getElementById('sub-indicator').value;
                var percentage = document.getElementById('percentage').value;
                updateMap(country, subIndicator, percentage);
            });

            // Listen for a click event on the 'downloadBtn' element and open a new tab with the URL to a TIFF file
            document.getElementById('downloadBtn').addEventListener('click', function () {
                var csvUrl = 'https://unicefdownloadfiletest.blob.core.windows.net/prueba/Exposure_change_for_Countries_2023.csv'
                window.open(csvUrl, '_blank');
            });

            // Event listener for reset view button click
            document.getElementById('reset-view').addEventListener('click', function () {
                map.setView(defaultView, defaultZoom);
            });

        })();
    </script>
</body>

</html>